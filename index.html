<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Password Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="loading-spinner" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-white"></div>
    </div>
    
    <!-- App Container -->
    <div id="app-container" class="w-full h-full">

        <!-- Login View -->
        <div id="loginView" class="w-full flex justify-center items-center p-4">
            <div class="bg-white p-8 rounded-xl shadow-lg max-w-md w-full">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Password Manager Login</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-gray-700">Email</label>
                        <input type="email" id="login-email" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-gray-700">Password</label>
                        <input type="password" id="login-password" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <p id="login-error" class="text-red-500 text-center mb-4"></p>
                    <button type="submit" class="w-full px-4 py-2 font-semibold text-white rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500">Login</button>
                </form>
            </div>
        </div>

        <!-- Master Password View -->
        <div id="masterPasswordView" class="hidden w-full flex justify-center items-center p-4">
             <div class="bg-white p-8 rounded-xl shadow-lg max-w-md w-full">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">Enter Master Password</h2>
                <p class="text-center text-gray-600 mb-6">This password encrypts your data and is never stored. If you forget it, your data cannot be recovered.</p>
                <form id="master-password-form">
                    <div class="mb-4 relative">
                        <input type="password" id="master-password-input" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Your Master Password" required>
                        <div id="master-password-spinner" class="absolute inset-y-0 right-0 flex items-center pr-3 hidden">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-gray-900"></div>
                        </div>
                    </div>
                    <p id="master-password-error" class="text-red-500 text-center mb-4"></p>
                    <button type="submit" class="w-full px-4 py-2 font-semibold text-white rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500">Unlock Vault</button>
                    <button type="button" id="master-password-sign-out" class="w-full px-4 py-2 font-semibold text-white rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 bg-gray-600 hover:bg-gray-700 focus:ring-gray-500 mt-2">Sign Out</button>
                </form>
            </div>
        </div>

        <!-- PIN Setup View -->
        <div id="pinSetupView" class="hidden w-full flex justify-center items-center p-4">
            <div class="bg-white p-8 rounded-xl shadow-lg max-w-md w-full">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">Set Up Your 4-Digit PIN</h2>
                <p class="text-center text-gray-600 mb-6">Create a 4-digit PIN for quick access after unlocking.</p>
                <form id="pin-setup-form">
                    <input type="password" id="pin-setup-input" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-center tracking-[1em]" maxlength="4" pattern="\d{4}" required>
                    <p id="pin-setup-error" class="text-red-500 text-center mt-4"></p>
                    <button type="submit" class="w-full px-4 py-2 font-semibold text-white rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500 mt-6">Save PIN</button>
                </form>
            </div>
        </div>
        
        <!-- PIN Entry View -->
        <div id="pinEntryView" class="hidden w-full flex justify-center items-center p-4">
            <div class="bg-white p-8 rounded-xl shadow-lg max-w-md w-full">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Enter Your 4-Digit PIN</h2>
                <form id="pin-entry-form">
                    <input type="password" id="pin-entry-input" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-center tracking-[1em]" maxlength="4" pattern="\d{4}" required>
                    <p id="pin-entry-error" class="text-red-500 text-center mt-4"></p>
                    <button type="submit" class="w-full px-4 py-2 font-semibold text-white rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500 mt-6">Enter</button>
                </form>
            </div>
        </div>

        <!-- Main Content View (Vault) -->
        <div id="mainView" class="hidden container mx-auto p-4 md:p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Password Vault</h1>
                <div>
                    <button id="add-password-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition">Add Password</button>
                    <button id="sign-out-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-700 transition ml-2">Sign Out</button>
                </div>
            </div>
            
            <div class="mb-4">
                <input type="text" id="search-input" placeholder="Search for a website..." class="w-full p-3 border border-gray-300 rounded-lg">
            </div>

            <div id="password-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Password items will be injected here -->
            </div>
        </div>

    </div>

    <!-- Modals -->
    <div id="password-modal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-20 p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-lg">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-gray-800">Add New Password</h2>
            <form id="password-form">
                <input type="hidden" id="password-id">
                <div class="mb-4">
                    <label for="website" class="block text-gray-700">Website</label>
                    <input type="text" id="website" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="username" class="block text-gray-700">Username/Email</label>
                    <input type="text" id="username" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="password" class="block text-gray-700">Password</label>
                    <div class="flex items-center space-x-2">
                        <input type="password" id="password" class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        <button type="button" id="generate-password-btn" class="bg-gray-200 p-2 rounded-lg hover:bg-gray-300" title="Generate Password">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 16v-2m8-8h-2M4 12H2m15.364 6.364l-1.414-1.414M6.05 6.05L4.636 4.636m12.728 0l-1.414 1.414M6.05 17.95l1.414-1.414m0-11.314L12 12l-1.414-1.414" /></svg>
                        </button>
                    </div>
                </div>
                <div id="generator-options" class="hidden p-4 bg-gray-50 rounded-lg mb-4">
                     <div class="mb-2">
                        <label for="length" class="block text-sm font-medium text-gray-700">Length: <span id="length-val">16</span></label>
                        <input type="range" id="length" min="8" max="32" value="16" class="w-full">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="flex items-center"><input type="checkbox" id="uppercase" class="mr-2" checked> Uppercase</label>
                        <label class="flex items-center"><input type="checkbox" id="lowercase" class="mr-2" checked> Lowercase</label>
                        <label class="flex items-center"><input type="checkbox" id="numbers" class="mr-2" checked> Numbers</label>
                        <label class="flex items-center"><input type="checkbox" id="symbols" class="mr-2" checked> Symbols</label>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancel-password-btn" class="w-full px-4 py-2 font-semibold text-gray-800 bg-gray-300 hover:bg-gray-400 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2">Cancel</button>
                    <button type="submit" class="w-full px-4 py-2 font-semibold text-white rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-30 p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm text-center">
            <h2 id="confirm-title" class="text-xl font-bold mb-4 text-gray-800">Are you sure?</h2>
            <p id="confirm-message" class="text-gray-600 mb-6">Do you really want to delete this item?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="w-full px-4 py-2 font-semibold text-gray-800 bg-gray-300 hover:bg-gray-400 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2">Cancel</button>
                <button id="confirm-ok-btn" class="w-full px-4 py-2 font-semibold text-white bg-red-600 hover:bg-red-700 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2">Delete</button>
            </div>
        </div>
    </div>

    <div id="toast" class="hidden fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg">
        Copied to clipboard!
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, off, remove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCS6KsJTcfmv4RCG-6Pqe4cHmk6W_wICBU",
            authDomain: "password-manager-8c234.firebaseapp.com",
            projectId: "password-manager-8c234",
            storageBucket: "password-manager-8c234.appspot.com",
            messagingSenderId: "449198798135",
            appId: "1:449198798135:web:d2205bf58692fe08a856b2",
            databaseURL: "https://password-manager-8c234-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- DOM Elements ---
        const DOMElements = {
            loadingSpinner: document.getElementById('loading-spinner'),
            appContainer: document.getElementById('app-container'),
            views: {
                login: document.getElementById('loginView'),
                masterPassword: document.getElementById('masterPasswordView'),
                pinSetup: document.getElementById('pinSetupView'),
                pinEntry: document.getElementById('pinEntryView'),
                main: document.getElementById('mainView'),
            },
            loginForm: document.getElementById('login-form'),
            loginError: document.getElementById('login-error'),
            masterPasswordForm: document.getElementById('master-password-form'),
            masterPasswordError: document.getElementById('master-password-error'),
            masterPasswordSpinner: document.getElementById('master-password-spinner'),
            masterPasswordSignOutBtn: document.getElementById('master-password-sign-out'),
            pinSetupForm: document.getElementById('pin-setup-form'),
            pinSetupError: document.getElementById('pin-setup-error'),
            pinEntryForm: document.getElementById('pin-entry-form'),
            pinEntryError: document.getElementById('pin-entry-error'),
            signOutBtn: document.getElementById('sign-out-btn'),
            addPasswordBtn: document.getElementById('add-password-btn'),
            passwordList: document.getElementById('password-list'),
            searchInput: document.getElementById('search-input'),
            passwordModal: document.getElementById('password-modal'),
            passwordForm: document.getElementById('password-form'),
            modalTitle: document.getElementById('modal-title'),
            cancelPasswordBtn: document.getElementById('cancel-password-btn'),
            generatePasswordBtn: document.getElementById('generate-password-btn'),
            generatorOptions: document.getElementById('generator-options'),
            lengthSlider: document.getElementById('length'),
            lengthVal: document.getElementById('length-val'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmOkBtn: document.getElementById('confirm-ok-btn'),
            confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
            toast: document.getElementById('toast'),
        };

        // --- App State ---
        let masterPasswordKey = null;
        let userPin = null;
        let currentPasswords = [];
        let unsubscribeFromPasswords = null;

        // --- Utility Functions ---
        let confirmCallback = null;
        
        const showToast = (message) => {
            DOMElements.toast.textContent = message;
            DOMElements.toast.classList.remove('hidden');
            setTimeout(() => DOMElements.toast.classList.add('hidden'), 3000);
        };
        
        const copyToClipboard = (text) => {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text)
                    .then(() => showToast("Password copied to clipboard!"))
                    .catch(() => showToast("Failed to copy!"));
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand("copy");
                    showToast("Password copied to clipboard!");
                } catch (err) {
                    showToast("Failed to copy!");
                }
                document.body.removeChild(textArea);
            }
        };

        const showConfirmModal = (title, message, callback) => {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            confirmCallback = callback;
            DOMElements.confirmModal.classList.remove('hidden');
        };
        
        const closeConfirmModal = () => {
            DOMElements.confirmModal.classList.add('hidden');
            confirmCallback = null;
        };

        const changeView = (viewName) => {
            Object.values(DOMElements.views).forEach(view => view.classList.add('hidden'));
            if (DOMElements.views[viewName]) {
                DOMElements.views[viewName].classList.remove('hidden');
            }
        };

        // --- Crypto Functions ---
        const encrypt = (data, key) => CryptoJS.AES.encrypt(data, key).toString();

        const decrypt = (ciphertext, key) => {
            try {
                const bytes = CryptoJS.AES.decrypt(ciphertext, key);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                console.error("Decryption failed:", e);
                return null;
            }
        };

        const generatePassword = () => {
            const length = DOMElements.lengthSlider.value;
            const useUppercase = document.getElementById('uppercase').checked;
            const useLowercase = document.getElementById('lowercase').checked;
            const useNumbers = document.getElementById('numbers').checked;
            const useSymbols = document.getElementById('symbols').checked;

            const upper = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const lower = 'abcdefghijklmnopqrstuvwxyz';
            const numbers = '0123456789';
            const symbols = '!@#$%^&*()_+~`|}{[]:;?><,./-=';

            let charset = '';
            if (useUppercase) charset += upper;
            if (useLowercase) charset += lower;
            if (useNumbers) charset += numbers;
            if (useSymbols) charset += symbols;

            if (charset === '') return '';

            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            document.getElementById('password').value = password;
        };
        
        // --- Database Functions ---
        const getUserSettings = async (userId) => {
            const userSettingsRef = ref(db, `users/${userId}/settings`);
            const snapshot = await get(userSettingsRef);
            return snapshot.exists() ? snapshot.val() : null;
        };

        const saveUserSettings = async (userId, settings) => {
            const userSettingsRef = ref(db, `users/${userId}/settings`);
            await set(userSettingsRef, settings);
        };
        
        const savePassword = async (userId, passwordData) => {
            const passwordRef = ref(db, `users/${userId}/passwords/${passwordData.id}`);
            await set(passwordRef, passwordData);
        };
        
        const deletePassword = async (userId, passwordId) => {
            const passwordRef = ref(db, `users/${userId}/passwords/${passwordId}`);
            await remove(passwordRef);
        };
        
        const attachPasswordListener = (userId) => {
            if (unsubscribeFromPasswords) {
                unsubscribeFromPasswords();
            }
            const passwordsRef = ref(db, `users/${userId}/passwords`);
            unsubscribeFromPasswords = onValue(passwordsRef, (snapshot) => {
                const data = snapshot.val();
                currentPasswords = data ? Object.values(data) : [];
                renderPasswords();
            });
        };

        const detachPasswordListener = () => {
            if (unsubscribeFromPasswords) {
                unsubscribeFromPasswords();
                unsubscribeFromPasswords = null;
            }
        };

        // --- UI Rendering ---
        const renderPasswords = () => {
            if (!masterPasswordKey) return;
            const searchTerm = DOMElements.searchInput.value.toLowerCase();
            DOMElements.passwordList.innerHTML = '';
            
            const filtered = currentPasswords.filter(p => {
                const decryptedWebsite = decrypt(p.website, masterPasswordKey);
                const decryptedUsername = decrypt(p.username, masterPasswordKey);
                return (decryptedWebsite && decryptedWebsite.toLowerCase().includes(searchTerm)) ||
                       (decryptedUsername && decryptedUsername.toLowerCase().includes(searchTerm));
            });

            if (filtered.length === 0) {
                DOMElements.passwordList.innerHTML = `<p class="text-gray-500 col-span-full text-center">No passwords found. Add one to get started!</p>`;
                return;
            }

            filtered.forEach(p => {
                const decryptedWebsite = decrypt(p.website, masterPasswordKey);
                const decryptedUsername = decrypt(p.username, masterPasswordKey);
                const decryptedPass = decrypt(p.password, masterPasswordKey);

                if (!decryptedWebsite || !decryptedUsername || !decryptedPass) {
                    showToast("Decryption failed for an entry. Wrong master password?");
                    return;
                }

                const item = document.createElement('div');
                item.className = 'bg-white p-6 rounded-lg shadow-md';
                item.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800">${decryptedWebsite}</h3>
                    <p class="text-gray-600">${decryptedUsername}</p>
                    <div class="flex items-center mt-4 space-x-2">
                        <input type="password" value="${decryptedPass}" class="w-full p-2 border rounded-lg bg-gray-50" readonly id="pass-${p.id}">
                        <button data-action="toggle" data-id="${p.id}" class="p-2 hover:bg-gray-200 rounded-lg" title="Toggle visibility">👁</button>
                        <button data-action="copy" data-id="${p.id}" class="p-2 hover:bg-gray-200 rounded-lg" title="Copy password">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                    </div>
                    <div class="flex justify-end mt-4 space-x-2">
                        <button data-action="edit" data-id="${p.id}" class="text-sm text-indigo-600 hover:underline">Edit</button>
                        <button data-action="delete" data-id="${p.id}" class="text-sm text-red-600 hover:underline">Delete</button>
                    </div>
                `;
                DOMElements.passwordList.appendChild(item);
            });
        };

        // --- Event Listeners and Logic ---
        const setupEventListeners = () => {
            // Login
            DOMElements.loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                DOMElements.loadingSpinner.classList.remove('hidden');
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;

                signInWithEmailAndPassword(auth, email, password)
                    .catch(error => {
                        DOMElements.loginError.textContent = error.message;
                        DOMElements.loadingSpinner.classList.add('hidden');
                    });
            });

            // Master Password
            DOMElements.masterPasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const pass = document.getElementById('master-password-input').value;
                if (pass.length < 8) {
                    DOMElements.masterPasswordError.textContent = 'Master password must be at least 8 characters.';
                    return;
                }
                DOMElements.masterPasswordSpinner.classList.remove('hidden');
                DOMElements.masterPasswordError.textContent = '';

                try {
                    masterPasswordKey = pass;
                    const userSettings = await getUserSettings(auth.currentUser.uid);
                    
                    if (userSettings && userSettings.pin) {
                        const decryptedPin = decrypt(userSettings.pin, masterPasswordKey);
                        if (decryptedPin) {
                            userPin = decryptedPin;
                            changeView('pinEntry');
                        } else {
                            DOMElements.masterPasswordError.textContent = 'Incorrect master password.';
                            masterPasswordKey = null;
                        }
                    } else {
                        changeView('pinSetup');
                    }
                } catch (error) {
                    console.error("Error during master password processing:", error);
                    DOMElements.masterPasswordError.textContent = "An error occurred. Please try again.";
                    masterPasswordKey = null;
                } finally {
                    document.getElementById('master-password-input').value = '';
                    DOMElements.masterPasswordSpinner.classList.add('hidden');
                }
            });
            DOMElements.masterPasswordSignOutBtn.addEventListener('click', () => signOut(auth));

            // PIN Forms
            DOMElements.pinSetupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const pin = document.getElementById('pin-setup-input').value;
                const encryptedPin = encrypt(pin, masterPasswordKey);
                
                if (encryptedPin) {
                    await saveUserSettings(auth.currentUser.uid, { pin: encryptedPin });
                    userPin = pin;
                    attachPasswordListener(auth.currentUser.uid);
                    changeView('main');
                } else {
                    DOMElements.pinSetupError.textContent = "Failed to encrypt PIN. Please try again.";
                }
            });

            DOMElements.pinEntryForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const pin = document.getElementById('pin-entry-input').value;
                if (pin === userPin) {
                    attachPasswordListener(auth.currentUser.uid);
                    changeView('main');
                } else {
                    DOMElements.pinEntryError.textContent = 'Incorrect PIN.';
                }
            });

            // Main View
            DOMElements.signOutBtn.addEventListener('click', () => signOut(auth));
            DOMElements.addPasswordBtn.addEventListener('click', () => {
                DOMElements.passwordForm.reset();
                document.getElementById('password-id').value = '';
                DOMElements.modalTitle.textContent = 'Add New Password';
                DOMElements.passwordModal.classList.remove('hidden');
            });
            DOMElements.searchInput.addEventListener('input', renderPasswords);

            // Password List Actions (delegation)
            DOMElements.passwordList.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const action = button.dataset.action;
                const id = button.dataset.id;
                
                if (action === 'copy') {
                    const passInput = document.getElementById(`pass-${id}`);
                    copyToClipboard(passInput.value);
                } else if (action === 'toggle') {
                    const passInput = document.getElementById(`pass-${id}`);
                    passInput.type = passInput.type === 'password' ? 'text' : 'password';
                } else if (action === 'edit') {
                    const passwordData = currentPasswords.find(p => p.id === id);
                    if (passwordData) {
                        document.getElementById('password-id').value = passwordData.id;
                        document.getElementById('website').value = decrypt(passwordData.website, masterPasswordKey);
                        document.getElementById('username').value = decrypt(passwordData.username, masterPasswordKey);
                        document.getElementById('password').value = decrypt(passwordData.password, masterPasswordKey);
                        DOMElements.modalTitle.textContent = 'Edit Password';
                        DOMElements.passwordModal.classList.remove('hidden');
                    }
                } else if (action === 'delete') {
                    showConfirmModal('Delete Password', 'Are you sure you want to delete this password entry? This action cannot be undone.', () => {
                        deletePassword(auth.currentUser.uid, id);
                        closeConfirmModal();
                    });
                }
            });

            // Password Modal
            DOMElements.cancelPasswordBtn.addEventListener('click', () => {
                DOMElements.passwordModal.classList.add('hidden');
            });

            DOMElements.passwordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('password-id').value || crypto.randomUUID();
                const website = document.getElementById('website').value;
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                const encryptedWebsite = encrypt(website, masterPasswordKey);
                const encryptedUsername = encrypt(username, masterPasswordKey);
                const encryptedPassword = encrypt(password, masterPasswordKey);
                
                if (!encryptedWebsite || !encryptedUsername || !encryptedPassword) {
                    showToast("Failed to encrypt data. Cannot save.");
                    return;
                }
                
                const passwordData = { id, website: encryptedWebsite, username: encryptedUsername, password: encryptedPassword };
                savePassword(auth.currentUser.uid, passwordData);
                DOMElements.passwordModal.classList.add('hidden');
            });
            
            // Password Generator
            DOMElements.generatePasswordBtn.addEventListener('click', () => {
                DOMElements.generatorOptions.classList.toggle('hidden');
                if (!DOMElements.generatorOptions.classList.contains('hidden')) {
                    generatePassword();
                }
            });
            DOMElements.lengthSlider.addEventListener('input', (e) => {
                DOMElements.lengthVal.textContent = e.target.value;
                generatePassword();
            });
            ['uppercase', 'lowercase', 'numbers', 'symbols'].forEach(id => {
                document.getElementById(id).addEventListener('change', generatePassword);
            });
            
            // Confirm Modal
            DOMElements.confirmOkBtn.addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
            });
            DOMElements.confirmCancelBtn.addEventListener('click', closeConfirmModal);
        };

        // --- App Initialization ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                changeView('masterPassword');
            } else {
                detachPasswordListener();
                masterPasswordKey = null;
                userPin = null;
                currentPasswords = [];
                renderPasswords();
                changeView('login');
            }
            DOMElements.loadingSpinner.classList.add('hidden');
        });

        setupEventListeners();
    </script>
</body>
</html>
